<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=0">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"/>
        <style>
            body { background-color: #f5f6f7; font-family: "Inter", sans-serif; color: black; padding-left: 5px; padding-right: 5px; margin-bottom: 80px; }
            .top-bar { display: flex; margin-top: 15px;}
            .ic{ font-size: 30px; text-decoration: none; color: black;}
            .ic2{ font-size: 30px; margin-left: auto; margin-right: 15px;}
            .ic3{ font-size: 30px;}
            .head{ font-size: 44px; color: grey; font-weight: 700; text-align: left; margin-bottom:0; outline: none; padding: 0 10px;}
            .body{ font-size: 20px; color: grey; text-align: left; margin-top: 22px; outline: none; min-height: 300px; padding: 0 10px;}
            .body img { display: block; width: 100%; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
            .bottom-bar { display: flex; padding: 15px; width: 100%; height: fit-content; background-color: white; color: black; position: fixed; bottom: 0; left: 0; gap: 40px; box-sizing: border-box; justify-content: space-around; border-top: 1px solid #eee; z-index: 1000;}
            .popup-bottom{ position:fixed; bottom:0; left:0; width:100%;  background:#fff; padding:12px 0; transform:translateY(100%); transition:transform 0.35s ease; z-index:1001;}
            .popup-bottom.active{ transform:translateY(0);}
            .popup-close{ position:absolute; top:0; left:0; width:64px; height:100%; background:#fff; display:flex; align-items:center; justify-content:center; z-index:2;}
            .popup-close span{ background:#e0e0e0; border-radius:50%; padding:6px; font-size:22px; color:#000; z-index:3;}
            .popup-icons{ display:flex; gap:30px; padding-left:80px; padding-right:20px; overflow-x:auto; overflow-y:hidden; white-space:nowrap;}
            .popup-icons::-webkit-scrollbar{ display:none;}
            .menu-popup{ position:fixed; top:52px; right:12px; background:#fff; border-radius:14px; min-width:160px; box-shadow:0 8px 24px rgba(0,0,0,0.18); transform: scale(0); transform-origin: top right; opacity:0; pointer-events:none; transition: transform 0.25s ease-out, opacity 0.25s ease-out; z-index:1001;}
            .menu-item{ padding:10px 14px; font-size:16px; font-weight: 400; color:#000; cursor:pointer;}
            .menu-item:hover{ background:#f2f2f2;}
            .menu-item-r{ padding:10px 14px; font-size:16px; font-weight: 400; color:red; cursor:pointer;}
            .menu-item-b{ padding:10px 14px; font-size:16px; font-weight: 400; color: blue; cursor:pointer;}
            .menu-item:hover{ background:#f2f2f2;}
            .menu-popup.active{ transform: scale(1); opacity:1; pointer-events:auto;}
            .menu-overlay{ position: fixed; inset: 0; background: rgba(0,0,0,0.35); opacity: 0; pointer-events: none; transition: opacity 0.25s ease; z-index: 1000;}
            .menu-overlay.active{ opacity:1; pointer-events:auto;}
            .botm-ic{ width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s ease; font-size: 28px; cursor: pointer;}
            /* Stylized active state for buttons */
            .botm-ic.active{ background: #e0e0e0; color: #007AFF; }
            .thin-divider { background-color: lightgrey; height: 2px; width: 100%}
            /* Overlay */
#addPopupOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1002;
}

/* Popup */
#addPopup {
    position: fixed;
    left: 50%;
    bottom: -100%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px; /* optional max-width */
    background: white;
    border-radius: 12px 12px 0 0;
    padding: 12px;
    box-sizing: border-box;
    height: fit-content;
    transition: bottom 0.35s ease;
    z-index: 1003;
    background-color: #f5f6f7;
}

/* Active state */
#addPopupOverlay.active {
    opacity: 1;
    pointer-events: auto;
}

#addPopup.active {
    bottom: 0;
}

/* Horizontal scroll container */
.add-popup-scroll {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 8px;
}
.add-popup-scroll::-webkit-scrollbar { display: none; }

/* Book card */
.add-book-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 120px;
    max-width: 120px;
    background: #fff;
    border-radius: 12px;
    padding: 8px;
    box-sizing: border-box;
    gap: 6px;
}

/* Book cover */
.add-book-card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-top-right-radius: 14px;
    border-bottom-right-radius: 14px;
}

/* Book name */
.add-book-name {
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    margin: 0;
    color: black;
}

/* Add button */
.add-book-btn {
    font-size: 15px;
    color: blue;
    background: 0;
    border: 0;
}
.add-book-btn.added {
    font-size: 15px;
    color: white;
    background: blue;
    border: 0;
    pointer-events: none;
    border-radius: 32px;
    padding-left: 12px;
    padding-right: 12px;
    padding-top: 3px;
    padding-bottom: 3px;
}
.page-container {
    background-color: #f5f6f7;
    border-radius: 18px 18px 0 0;
    min-height: 100vh;
    overflow: hidden; /* VERY IMPORTANT */
}
.menu-popup {
    overflow: hidden;
}

.menu-item {
    -webkit-tap-highlight-color: transparent;
}

.menu-item:first-child:active {
    border-top-left-radius: 14px;
    border-top-right-radius: 14px;
}
        </style>
    </head>
    <body>
        <div class="page-container">
        <div class="top-bar">
            <span class="material-symbols-outlined ic" onclick="goBack()">arrow_back</span>
            <span class="material-symbols-outlined ic2" onclick="shareNote()">ios_share</span>
            <span class="material-symbols-outlined ic3" onclick="openMenu()">more_vert</span>
        </div>

        <p class="head" id="head-editor" contenteditable="true" onfocus="focusHead()" onblur="blurHead()">Heading</p>
        <div class="body" id="body-editor" contenteditable="true" onfocus="focusBody()">Start typing</div>

        <input type="file" id="img-input" hidden accept="image/*" onchange="insertImage(this)">

        <div class="bottom-bar" onmousedown="event.preventDefault()">
            <span class="material-symbols-outlined botm-ic" onclick="addCheckbox()">check_box_outline_blank</span>
            <span class="material-symbols-outlined botm-ic" onclick="document.getElementById('img-input').click()">photo</span>
            <span class="material-symbols-outlined botm-ic" onclick="addBullet()">format_list_bulleted</span>
            <span class="material-symbols-outlined botm-ic" onclick="openPopup()">text_fields</span>
            <span class="material-symbols-outlined botm-ic" onclick="location.href='about.html'">info</span>

            <div class="popup-bottom" id="popupBottom">
                <div class="popup-close"><span class="material-symbols-outlined" onclick="closePopup()">close</span></div>
                <div class="popup-icons">
                    <span id="btn-bold" class="material-symbols-outlined botm-ic" onclick="toggleFormat(this,'bold')">format_bold</span>
                    <span id="btn-italic" class="material-symbols-outlined botm-ic" onclick="toggleFormat(this,'italic')">format_italic</span>
                    <span id="btn-underline" class="material-symbols-outlined botm-ic" onclick="toggleFormat(this,'underline')">format_underlined</span>
                    <span id="align-btn" class="material-symbols-outlined botm-ic" onclick="cycleAlignment(this)">format_align_left</span>
                </div>
            </div>
        </div>

        <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>  
        <div class="menu-popup" id="menuPopup">  
            <div class="menu-item" onclick="menuAction('feedback')">Feedback</div>
<div class="menu-item" onclick="menuAction('about')">About</div>
            <div class="menu-item-b" onclick="shareNote()">Share</div>
            <div class="thin-divider"></div>
            <div class="menu-item-r" onclick="deleteNote()">delete</div> 
            
        </div> 
        <div id="popupContainer"></div>
<!-- Add-to-book empty popup -->
<!-- Overlay -->
<!-- Add to Book Popup Overlay -->
<div id="addPopupOverlay"></div>

<!-- Add to Book Popup -->
<div id="addPopup">
    <div class="add-popup-scroll">
        <!-- Books will be loaded here dynamically -->
    </div>
</div>
</div>
        </body>
<script>        /* ------------------ BASIC SETUP ------------------ */ const editorHead = document.getElementById('head-editor');
const editorBody = document.getElementById('body-editor');
let savedRange = null;

const checkboxHTML = '<input type="checkbox" style="width:20px; height:20px; vertical-align:middle; margin-right:8px;">';
const bulletHTML = '•&nbsp;';

const urlParams = new URLSearchParams(window.location.search);
let currentNoteId = urlParams.get('id');

/* ------------------ SELECTION TRACKING ------------------ */
function saveSelection() {
    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        // Ensure the selection is actually inside the editor body
        const container = sel.getRangeAt(0).commonAncestorContainer;
        if (editorBody.contains(container) || container === editorBody) {
            savedRange = sel.getRangeAt(0).cloneRange();
        }
    }
    updateUIState(); 
}

function restoreSelection() {
    if (savedRange) {
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedRange);
    }
}

// Track cursor to update icon highlights
editorBody.addEventListener('mouseup', saveSelection);
editorBody.addEventListener('keyup', saveSelection);
editorBody.addEventListener('touchend', saveSelection);

/* ------------------ FORMAT TOGGLE (FIXED) ------------------ */
function toggleFormat(el, cmd) {
    // Prevent the click from bubbling to other elements
    if (event) event.stopPropagation();

    editorBody.focus();
    restoreSelection();

    // Execute the command
    document.execCommand(cmd, false, null);
    
    // Immediately update selection and UI
    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        savedRange = sel.getRangeAt(0).cloneRange();
    }
    
    updateUIState();
    saveNote();
}

// Fixed UI State logic to prevent "bleeding" into nearby icons
function updateUIState() {
    const formats = [
        { id: 'btn-bold', cmd: 'bold' },
        { id: 'btn-italic', cmd: 'italic' },
        { id: 'btn-underline', cmd: 'underline' }
    ];

    formats.forEach(f => {
        const btn = document.getElementById(f.id);
        if (btn) {
            // queryCommandState returns true ONLY if the command is active for current selection
            try {
                if (document.queryCommandState(f.cmd)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            } catch (e) {
                btn.classList.remove('active');
            }
        }
    });
}

/* ------------------ ALIGNMENT CYCLING ------------------ */
function cycleAlignment(el) {
    if (event) event.stopPropagation();
    editorBody.focus();
    restoreSelection();

    const currentIcon = el.innerText;

    if (currentIcon === 'format_align_left') {
        document.execCommand('justifyCenter', false, null);
        el.innerText = 'format_align_center';
    } else if (currentIcon === 'format_align_center') {
        document.execCommand('justifyRight', false, null);
        el.innerText = 'format_align_right';
    } else {
        document.execCommand('justifyLeft', false, null);
        el.innerText = 'format_align_left';
    }

    saveSelection();
    saveNote();
}

/* ------------------ LOAD/SAVE NOTE ------------------ */
window.onload = () => {
  if (currentNoteId) {
    const notes = JSON.parse(localStorage.getItem('allNotes') || '[]');
    const note = notes.find(n => n.id == currentNoteId);
    if (note) {
      if (note.title) {
        editorHead.innerText = note.title;
        editorHead.style.color = 'black';
      }
      if (note.content) {
        editorBody.innerHTML = note.content;
        editorBody.style.color = 'black';
      }
    }
  }
};

function saveNote() {
  const title = (editorHead.innerText.trim() === 'Heading') ? '' : editorHead.innerText.trim();
  const content = (editorBody.innerText.trim() === 'Start typing') ? '' : editorBody.innerHTML.trim();
  
  if (!currentNoteId && (title || content)) {
    currentNoteId = Date.now();
    const newUrl = location.protocol + "//" + location.host + location.pathname + '?id=' + currentNoteId;
    history.replaceState({}, '', newUrl);
  }

  if (currentNoteId) {
    let notes = JSON.parse(localStorage.getItem('allNotes') || '[]');
    const index = notes.findIndex(n => n.id == currentNoteId);
    const noteData = { id: currentNoteId, title, content, time: Date.now() };
    if (index > -1) notes[index] = noteData;
    else notes.push(noteData);
    localStorage.setItem('allNotes', JSON.stringify(notes));
  }
}

editorHead.addEventListener('input', saveNote);
editorBody.addEventListener('input', saveNote);

/* ------------------ EDITOR HELPERS ------------------ */
function goBack() {
  saveNote();
  location.href = "index.html";
}

function focusHead() {
  if (editorHead.innerText.trim() === 'Heading') editorHead.innerText = '';
  editorHead.style.color = 'black';
}
function blurHead() {
  if (editorHead.innerText.trim() === '') {
    editorHead.innerText = 'Heading';
    editorHead.style.color = 'grey';
  }
}
function focusBody() {
  if (editorBody.innerText.trim() === 'Start typing') {
    editorBody.innerText = '';
    editorBody.style.color = 'black';
  }
}

function getCurrentLine() {
  const sel = window.getSelection();
  if (!sel.rangeCount) return null;
  let node = sel.anchorNode;
  while (node && node.parentNode !== editorBody && node !== editorBody) node = node.parentNode;
  return node;
}

/* ------------------ CHECKBOX & BULLET ------------------ */
function addCheckbox() {
  editorBody.focus();
  let line = getCurrentLine();
  if (!line || (line.querySelector && line.querySelector('input'))) return;
  if (line === editorBody || line.nodeType === 3)
    document.execCommand('insertHTML', false, `<div>${checkboxHTML}&nbsp;</div>`);
  else
    line.insertAdjacentHTML('afterbegin', checkboxHTML);
  saveNote();
}

function addBullet() {
  editorBody.focus();
  let line = getCurrentLine();
  if (!line || line.textContent.trim().startsWith('•')) return;
  if (line === editorBody || line.nodeType === 3)
    document.execCommand('insertHTML', false, `<div>${bulletHTML}</div>`);
  else
    line.insertAdjacentHTML('afterbegin', bulletHTML);
  saveNote();
}

/* ------------------ IMAGE ------------------ */
function insertImage(input) {
  if (!input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    editorBody.focus();
    document.execCommand('insertHTML', false, `<div><img src="${e.target.result}"></div><div><br></div>`);
    saveNote();
  };
  reader.readAsDataURL(input.files[0]);
}

/* ------------------ POPUPS ------------------ */
function openPopup() {
  saveSelection();
  document.getElementById("popupBottom").classList.add("active");
}
function closePopup() {
  document.getElementById("popupBottom").classList.remove("active");
}

/* ------------------ MENU ------------------ */
function openMenu() {
  document.getElementById("menuPopup").classList.add("active");
  document.getElementById("menuOverlay").classList.add("active");
}
function closeMenu() {
  document.getElementById("menuPopup").classList.remove("active");
  document.getElementById("menuOverlay").classList.remove("active");
}
function deleteNote() {
  if (!currentNoteId) {
    alert("Nothing to delete");
    return;
  }

  const confirmDelete = confirm("Delete this note?");  
  if (!confirmDelete) return;  
  
  let notes = JSON.parse(localStorage.getItem('allNotes') || '[]');
  notes = notes.filter(n => n.id != currentNoteId);
  localStorage.setItem('allNotes', JSON.stringify(notes));

  closeMenu();
  location.href = "index.html";
}
function shareNote() {
  const title = editorHead.innerText.trim() || "My Note";
  const text = editorBody.innerText.trim(); // ✅ TEXT ONLY

  if (!text) {
    alert("Nothing to share");
    return;
  }

  const shareText = title + "\n\n" + text;

  if (navigator.share) {
    navigator.share({
      text: shareText   // ✅ only text, no title object
    }).catch(() => {});
  } else {
    navigator.clipboard.writeText(shareText);
    alert("Text copied to clipboard");
  }

  closeMenu();
}   

// Escape HTML to prevent XSS and keep book names safe
function escapeHtml(text) {
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
// Element
function menuAction(type) {
    // Close menu first (prevents radius glitch)
    closeMenu();

    // Small delay lets active state finish cleanly
    setTimeout(() => {
        if (type === 'feedback') {
            window.location.href = "mailto:apps.vishalvaishnav@outlook.com";
        } else if (type === 'about') {
            location.href = "about.html";
        }
    }, 120);
}
        </script>
    </body>
</html>