<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <!-- PWA basics -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<!-- REQUIRED FOR PWABUILDER -->
<meta name="application-name" content="Orbit Notes">
<meta name="apple-mobile-web-app-title" content="Orbit Notes">
<meta name="description" content="Orbit Notes - Simple and clean note taking app">
        <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24..48,400,0..1,0"/>
        <style>
            body { background-color: #f5f6f7; font-family: "Inter", sans-serif; color: black; padding-left: 5px; padding-right: 5px;
            }
            
            .top-bar { display: flex; justify-content: flex-end; align-items: left;
            }
            
            .page-tt { font-size: 60px; text-align: left; color: black; margin-top: 0; margin-bottom: 15px;
            }
            
            .set-ic { font-variation-settings: 'FILL' 1; margin-top: 12px; margin-right: 12px; font-size: 28px;
            }
            
                .search-bar { width: 100%; box-sizing: border-box; background-color: lightgrey; color: grey; padding: 12px; border-radius: 32px; padding-left: 19px; display: flex; align-items: center; gap: 2px; margin-top: 0;
}

            .search-ic { vertical-align: center;}
            
            .notes{width:100%;height:fit-content;background-color:white;border-radius:18px;padding:12px 45px 12px 12px;margin-top:15px;text-align:left;box-sizing:border-box;}
            .note-head { font-size: 22px; font-weight: 700; margin-top: 15px; margin-bottom: 0; margin-left: 12px;}
            
            .note-body {font-size: 15px; color: grey; margin-top: 0; margin-left: 12px;}
            
            .create-circle{ position:fixed; bottom:12px; right:12px; width:56px; height:56px; background-color:#2979FF; color:white; border-radius:50%; display:flex; justify-content:center; box-shadow:0 8px 20px rgba(41,121,255,0.45); align-items:center; cursor:pointer; z-index:999; margin:0; }
            
            .create-ic { font-size:28px; margin:0; }
            
            .open-anim{
    position:fixed;
    bottom:24px;
    right:24px;
    width:56px;
    height:56px;
    background:#fff;
    border-radius:100%;
    z-index:999;
    transform:scale(0);
    transition:transform 0.75s ease-in-out, border-radius 0.75s ease-in-out;
    box-shadow:0 12px 30px rgba(0,0,0,0.18);
}

.open-anim.active{
    transform:scale(40);
    border-radius:100%;
    box-shadow:0 12px 30px rgba(0,0,0,0.18);
}
.bottom-bar-navi{ display:flex; gap:20px; padding:10px; background:white; position:fixed; bottom:12px; left:18px; border-radius:15px; width:fit-content; height:fit-content; box-shadow:0 2px 8px rgba(0,0,0,0.12); z-index:998; }

.bottom-bar-navi{ display:flex; gap:12px; padding:10px; background:white; position:fixed; bottom:12px; left:18px; border-radius:15px; width:fit-content; height:fit-content; box-shadow:0 2px 8px rgba(0,0,0,0.12); z-index:998; }

.bottom-item{ display:flex; align-items:center; justify-content:center; padding:6px 12px; border-radius:12px; cursor:pointer; gap:6px; }

.bottom-item.active{ background:#e0e0e0; } /* light grey background for active item */

.botm-ic{ font-size:32px; color:black; font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0; } /* unfilled */

.botm-ic-dark{ font-size:32px; color:black; font-variation-settings:'FILL' 1,'wght' 400,'GRAD' 0; } /* filled */

.bottom-label{ font-size:14px; color:black; font-weight: 500;}

.notes.selected{
    background:#e8f0ff;
    border:2px solid #2979FF;
}

/* Overlay */
.popup-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 1500;
}

/* Bottom Popup */
.bottom-popup{
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: -100%;
    background: #fff;
    border-radius: 22px;
    padding: 14px;
    box-shadow: 0 -8px 24px rgba(0,0,0,0.18);
    transition: bottom 0.3s ease;
    z-index: 1501;
    padding-right: 25px;
}

/* Active states */
.popup-overlay.active{
    opacity: 1;
    pointer-events: auto;
}

.bottom-popup.active{
    bottom: 12px;
}

/* Small handle (MIUI style) */
.popup-handle{
    width: 42px;
    height: 5px;
    background: #ccc;
    border-radius: 10px;
    margin: 6px auto 22px auto;
}

/* Example items */
.popup-item{
    padding: 14px;
    font-size: 16px;
    border-radius: 14px;
    cursor: pointer;
    margin: 0;          /* remove top/bottom margin */
    line-height: 0.80;   /* reduce extra line spacing */
}
.popup-item-b {color: #2979FF;}
.popup-item + .popup-item {
    margin-top: 0;      /* ensure no spacing between items */
}

.popup-item:hover{
    background: #f2f2f2;
}
.pop-topbar{
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

/* Center text */
.pop-center{
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    margin-top: 20px;
}

/* Right aligned close */
.pop-right{
    position: absolute;
    right: 0;
}
.pop-txt-b { font-size: 18px; color: #2979FF; font-weight: 600; margin:0; cursor:pointer; user-select:none; }
        .pop-txt-bl { font-size: 18px; color: black; font-weight: 600; margin:0; cursor:pointer; user-select:none; }
        .thin-divider { background-color: lightgrey; height: 2px; width: 100%}
        </style>
    </head>
    <body>
        <div class="top-bar">
    <!-- no inline onclick here; topActionClick will be wired in JS -->
    <span class="material-symbols-outlined set-ic" id="topAction">more_vert</span>
</div>
<p class="page-tt" id="pageTitle">Notes</p>
        <div class="search-bar">
            <span class="material-symbols-outlined search-ic">search</span>Search
        </div>

        <div class="open-anim" id="openAnim"></div>

        <div class="create-circle" onclick="openEditor()">
            <span class="material-symbols-outlined create-ic">add_2</span>
        </div>

<div class="bottom-bar-navi">
    <div class="bottom-item active">
        <span class="material-symbols-outlined botm-ic-dark">note_stack</span>
        <span class="bottom-label">Notes</span>
    </div>
    <div class="bottom-item">
        <a href="book.html" style="text-decoration:none;color:inherit;">
        <span class="material-symbols-outlined botm-ic">book_2</span></a>
    </div>
</div>

    <div id="notes-container">
    </div>

    <!-- Bottom Popup Overlay -->
<div class="popup-overlay" id="popupOverlay" onclick="closeBottomPopup()"></div>

<!-- Bottom Popup -->
<div class="bottom-popup" id="bottomPopup">
    <div class="popup-handle"></div>

    <div class="pop-topbar">
        <p class="pop-txt-bl pop-center">Menu</p>
        <p class="pop-txt-b pop-right" onclick="closeBottomPopup()">Close</p>
    </div>

    <div class="popup-item" onclick="enableSelect()">Select</div>

    <div class="popup-item" onclick="sendFeedback()">Feedback</div>
<div class="thin-divider"></div>
    <div class="popup-item popup-item-b" onclick="openAbout()">About</div>
</div>
        <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(() => console.log('Service Worker Registered'))
      .catch(err => console.error(err));
  }
        </script>
    </body>
    <script>
/* ===== Global state ===== */
let selectionMode = false;
let selectedNotes = new Set();
let longPressTimer = null;
let longPressActive = false; // true briefly after a long-press
let actionLocked = false;    // lock top action while performing delete
const LONG_PRESS_MS = 500;

/* ===== Basic UI helpers ===== */
/* Removed menu functions - page uses bottom popup instead of a menu */

function topActionClick(){
    // block double clicks
    if(actionLocked) return;

    // âœ… CASE 1: multi-select active â†’ ONLY DELETE
    if(selectionMode){
        actionLocked = true;

        const topAction = document.getElementById('topAction');
        if(topAction) topAction.style.pointerEvents = 'none';

        deleteSelectedNotes();   // ðŸ”¥ only delete
        return;
    }else{
        // open the bottom popup (no menu)
        openBottomPopup();
    }
}

/* ===== Load and render notes ===== */
function loadNotes(){
    const container = document.getElementById('notes-container') || document.getElementById('notes-list');
    if(!container) return;

    let notes = JSON.parse(localStorage.getItem('allNotes') || '[]');

    if(!Array.isArray(notes) || notes.length === 0){
        container.innerHTML = `
    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; color:grey; background-color:#f5f6f7; margin-bottom: 0;">
        <img src="https://i.postimg.cc/MTJHQx2q/empty.png" 
             alt="No notes" 
             style="max-width:200px; margin-bottom:15px;">
        <p style="font-size:18px; text-align:center; margin-top: 0;">No notes yet</p>
    </div>
`;
        // ensure selection mode cleared
        exitSelectionMode();
        // unlock any action (safety)
        const topAction = document.getElementById('topAction');
        if(topAction){
            topAction.style.pointerEvents = '';
            actionLocked = false;
        }
        return;
    }

    // Ensure numeric ids and stable structure
    notes = notes.map(n => ({
        ...n,
        id: Number(n.id)
    }));

    // Sort newest first using numeric id
    notes.sort((a,b) => Number(b.id) - Number(a.id));

    // Render notes
    container.innerHTML = notes.map(note => {
        const body = (note.content || "").replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').trim();
        const title = note.title || "Untitled";
        const preview = body ? `${body.substring(0,40)}...` : "";
        return `
        <div class="notes" data-id="${Number(note.id)}"
             onmousedown="startLongPress(${Number(note.id)}, this)"
             onmouseup="cancelLongPress(this)"
             onmouseleave="cancelLongPress(this)"
             ontouchstart="startLongPress(${Number(note.id)}, this)"
             ontouchend="cancelLongPress(this)"
             ontouchcancel="cancelLongPress(this)"
             onclick="noteClick(${Number(note.id)}, this)">
            <p class="note-head">${escapeHtml(title)}</p>
            <p class="note-body">${escapeHtml(preview)}</p>
        </div>`;
    }).join('');

    // Ensure top action element click is wired
    wireTopActionIfNeeded();
}

/* Small helper to escape text inserted in HTML to avoid accidental markup */
function escapeHtml(text){
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

/* ===== Long-press detection ===== */
function startLongPress(id, el){
    id = Number(id);
    clearTimeout(longPressTimer);
    longPressActive = false;

    longPressTimer = setTimeout(() => {
        longPressActive = true;
        if(!selectionMode) selectionMode = true;
        toggleSelect(id, el);
        updateTopUI();
    }, LONG_PRESS_MS);
}

function cancelLongPress(el){
    clearTimeout(longPressTimer);
    if(longPressActive){
        setTimeout(()=> { longPressActive = false; }, 50);
    }
}

/* ===== Note click behavior ===== */
function noteClick(id, el){
    id = Number(id);
    // If long-press just fired, ignore this click to prevent opening editor
    if(longPressActive){
        // If in selection mode: treat as selection toggle
        if(selectionMode){
            toggleSelect(id, el);
            updateTopUI();
        }
        return;
    }

    // If selection mode active, toggle selection
    if(selectionMode){
        toggleSelect(id, el);
        updateTopUI();
        return;
    }

    // Normal open editor
    openEditor(id);
}

/* ===== Selection management ===== */
function toggleSelect(id, el){
    id = Number(id);
    if(!el){
        el = document.querySelector(`.notes[data-id="${id}"]`);
    }
    if(selectedNotes.has(id)){
        selectedNotes.delete(id);
        if(el) el.classList.remove('selected');
    }else{
        selectedNotes.add(id);
        if(el) el.classList.add('selected');
    }

    if(selectedNotes.size === 0){
        exitSelectionMode();
    }
}

/* ===== UI updates ===== */
function updateTopUI(){
    const pageTitle = document.getElementById('pageTitle');
    const topAction = document.getElementById('topAction');

    if(pageTitle){
        pageTitle.innerText = `Selected ${selectedNotes.size}`;
    }
    if(topAction){
        topAction.innerText = "delete";
    }
}

function exitSelectionMode(){
    selectionMode = false;
    selectedNotes.clear();

    const pageTitle = document.getElementById('pageTitle');
    const topAction = document.getElementById('topAction');

    if(pageTitle) pageTitle.innerText = "Notes";
    if(topAction) topAction.innerText = "more_vert";

    document.querySelectorAll('.notes.selected').forEach(n => n.classList.remove('selected'));
}

/* ===== Delete selected notes (robust numeric compare) ===== */
function deleteSelectedNotes(){
    // Double-safety: prevent re-entry
    if(actionLocked === false) actionLocked = true;
    const topAction = document.getElementById('topAction');
    if(topAction) topAction.style.pointerEvents = 'none';

    let notes = JSON.parse(localStorage.getItem('allNotes') || '[]');
    if(!Array.isArray(notes)) notes = [];

    // Filter out notes whose numeric id is in selectedNotes
    const filtered = notes.filter(note => !selectedNotes.has(Number(note.id)));

    localStorage.setItem('allNotes', JSON.stringify(filtered));

    // Clear selection state immediately
    exitSelectionMode();

    // Small delay to avoid race with click events and to allow UI to repaint
    setTimeout(() => {
        loadNotes();
        // re-enable click on topAction
        if(topAction) topAction.style.pointerEvents = '';
        actionLocked = false;
    }, 120);
}

/* ===== Editor navigation (with open animation if exists) ===== */
function openEditor(noteId = null){
    const anim = document.getElementById("openAnim");
    if(anim) anim.classList.add("active");

    setTimeout(() => {
        window.location.href = noteId ? `editor.html?id=${Number(noteId)}` : "editor.html";
    }, 550);
}

/* ===== Utility: wire topAction and overlay ===== */
function wireTopActionIfNeeded(){
    const topAction = document.getElementById('topAction');
    if(topAction && !topAction._wired){
        topAction.addEventListener('click', topActionClick);
        topAction._wired = true;
    }
}

/* ===== Initialize on page load ===== */
window.addEventListener('load', () => {
    wireTopActionIfNeeded();
    loadNotes();
});

/* ===== Bottom popup open/close (kept) ===== */
function openBottomPopup(){
    document.getElementById("popupOverlay").classList.add("active");
    document.getElementById("bottomPopup").classList.add("active");
}

function closeBottomPopup(){
    document.getElementById("popupOverlay").classList.remove("active");
    document.getElementById("bottomPopup").classList.remove("active");
}
function openAbout(){
    window.location.href = "about.html";
}

function sendFeedback(){
    window.location.href = "mailto:apps.vishalvaishnav@outlook.com";
}

function enableSelect(){
    // If already in multi-select, do nothing
    if(selectionMode) return;

    selectionMode = true;
    selectedNotes = new Set();

    // Update top bar UI
    const pageTitle = document.getElementById('pageTitle');
    const topAction = document.getElementById('topAction');
    if(pageTitle) pageTitle.innerText = "Selected 0";
    if(topAction) topAction.innerText = "delete";

    // Close bottom popup
    closeBottomPopup();
}
</script>
</html>
